<link rel="import" href="connected-clients-list-behavior.html" />
<link rel="import" href="../infrastructure-services/infrastructure-services-behavior.html" />
<link href="../../Scripts/Libs/Polymer/polymer.html" rel="import" />    
<dom-module id="connected-clients-list-component">
    <template>
            <div class="container-fluid" hidden$="{{noRecords}}">
                <div class="row">
                    <div class="col-md-12">
                        <hr />
                        <template is="dom-if" if="{{noMatches}}" id="noMatchesMessage">
                            <label class="sub-heading">{{noMatchesLabel}}</label>
                        </template>
                        <table class="table table-bordered komodo-datagrid" hidden$="{{noMatches}}">
                            <thead>
                                <tr>
                                    <th>{{machineNameLabel}}</th>
                                    <th>{{ipAddressLabel}}</th>
                                    <th>{{dateUpdatedLabel}}</th>
                                    <th>{{versionLabel}}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template is="dom-repeat" items$="[[filteredConnectedClientList]]" id="filteredList">
                                    <tr>
                                        <td>{{item.machineName}}</td>
                                        <td>{{item.ipAddress}}</td>
                                        <td>{{item.dateLastUpdated}}</td>
                                        <td>{{item.version}}</td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
              </div>
        </div>
   
</template>
</dom-module>
<script>
    Polymer({
        is: "connected-clients-list-component",
        behaviors: [ConnectedClientsListBehavior, InfrastructureServicesBehavior],
        properties: {
            countryCode: {
                type: String
            },
            dateUpdatedLabel: {
                type: String
            },
            machineNameLabel: {
                type: String
            },
            versionLabel: {
                type: String
            },
            ipAddressLabel: {
                type: String
            },
            noMatchesLabel: {
                type: String
            },
            noRecordsLabel: {
                type: String
            },
            fullConnectedClientList: {
                type: Array,
                notify: true
            },
            filteredConnectedClientList: {
                type: Array,
                notify: true,
                observer: 'checkForMatches'
            },
            filterDate: {
                type: String,
                notify: true,
                observer: '_filter'
            },
            filterMachineName: {
                type: String,
                notify: true,
                observer: '_filter'
            },
            filterVersion: {
                type: String,
                notify: true,
                observer: '_filter'
            },
            filterType: {
                type: String,
                notify: true,
            },
            noRecords: {
                type: Boolean,
                value: false,
                notify: true
            },
            noMatches: {
                type: Boolean,
                notify: true
            }//,
            //filterType: {
            //    type: String,
            //    notify: true,
            //    observer: 'filter'
            //}
        },
        ready: function () {
            this.dateUpdatedLabel = this.localizationService.value('locale.clientTracker:dateUpdated');
            this.machineNameLabel = this.localizationService.value('locale.clientTracker:machineName');
            this.versionLabel = this.localizationService.value('locale.clientTracker:version');
            this.ipAddressLabel = this.localizationService.value('locale.clientTracker:ipAddress');
            this.noMatchesLabel = this.localizationService.value('locale.clientTracker:noMatches');
            this.noRecordsLabel = this.localizationService.value('locale.clientTracker:noRecords');
            this.fetchConnectedClientsResource();
        },
        fetchConnectedClientsResource: function () {
            var me = this;
            this.fullConnectedClientList = [];
            this.communicationService.getResource('/connectedusers?countrycode=' + this.country).done(function (data) {
                data.forEach(function (item) {
                    var details = {
                        countryCode: item.countryCode,
                        dateLastUpdated: moment(item.dateLastUpdated).format(KomodoConfiguration.dateFormat),
                        ipAddress: item.ipAddress,
                        machineName: item.machineName,
                        version: item.version
                    };
                    me.fullConnectedClientList.push(details);
                });
                me.noRecords = false;
                if (me.filteredConnectedClientList === undefined) {
                    me._filter();
                }
            }).fail(function (error) {
                me.noRecords = true;
                Komodo.log(error);
            });
            
        },
        
        checkForMatches: function() {
            if (this.filteredConnectedClientList.length === 0) {
                this.noMatches = true;
            } else {
                this.noMatches = false;
            }
        },
       
        _filter: function () {
            this.debounce('filter', function () {
                var newArray = [];
                var me = this;
                if (this.fullConnectedClientList === undefined || this.fullConnectedClientList.length === 0) {
                    this.fetchConnectedClientsResource();
                } else {
                
                    if (this.filterMachineName == undefined && this.filterVersion == undefined && this.filterDate == undefined) {
                        this.filteredConnectedClientList = this.fullConnectedClientList;
                    }
                    else {
                        if (this.filterMachineName) {
                            this.filterMachineName = this.filterMachineName.toLowerCase();
                        }
                        this.fullConnectedClientList
                                        .forEach(function (item) {
                                            if ((me.filterDate !== undefined &&
                                                item.dateLastUpdated.includes(me.filterDate))
                                                || item.machineName.toLowerCase().includes(me.filterMachineName) || item.version.includes(me.filterVersion)) {
                                                newArray.push(item);
                                            }
                                        });

                        this.filteredConnectedClientList = newArray;
                    }
                }
                this.$.filteredList.render();
                this.$.noMatchesMessage.render();
            
            },500);
        }
    });

    
</script>
